/**
 * previewer图片预览组件
 * @author kuanglingxuan@chinaduo.com
 */
;(function($){$.uiwidget=$.uiwidget||{};$.uiwidget.Previewer=function(target,cfg){$.extend(this,cfg);this.target=target;this.init()};$.uiwidget.Previewer.prototype={status:'stop',loaderSrc:'../images/loader.gif',overflowCursor:'',containerHeight:600,containerWidth:800,data:[],index:0,period:2000,step:0,fadeSpeed:0,suitableHeigth:false,onChangeImage:function(){},onLoadError:function(){},init:function(){var t=this;t.target.addClass('previewer-container');t.target.css({position:'relative',overflow:'hidden',height:t.containerHeight,width:t.containerWidth});t.target.append('<div class="previewer-box" style="position:absolute;z-index:1;"><img class="previewer-image" style="display:none"/><img class="previewer-image-preload" style="display:none"/></div>');t.target.append('<img class="previewer-loader" src="'+t.loaderSrc+'" style="position:absolute;z-index:100;"/>');t.target.append('<a href="javascript:void(0)"  hidefocus="true" class="previewer-pre" title="上一张"></a>');t.target.append('<a href="javascript:void(0)"  hidefocus="true" class="previewer-next" title="下一张"></a>');t.imgEl=t.getImgEl();t.getLoaderEl().css({top:((t.containerHeight-t.loaderEl.height())/2),left:((t.containerWidth-t.loaderEl.width())/2)});t.imgEl.bind('load',t,t.afterRender);t.imgEl.bind('error',t,t.afterLoad);if(t.data.length>0&&t.onChangeImage)t.onChangeImage(t,t.getIndexValue(t.data,t.index),t.index);t.getNextEl().bind('click',t,t.onNext);t.getPreEl().bind('click',t,t.onPre);if(t.play){t.play.click(function(){t.interval=setInterval(function(){t.onChangeImage(t,t.getIndexValue(t.data,t.index+1),t.index)},t.period);t.status='play'})}if(t.pause){t.pause.click(function(){clearInterval(t.interval);t.status='pause'})}if(t.stop){t.stop.click(function(){clearInterval(t.interval);t.status='stop';t.index=0;t.onChangeImage(t,t.getIndexValue(t.data,t.index),t.index)})}if(t.leftRotate){t.leftRotate.click(function(){t.rotateImage('left')})}if(t.rightRotate){t.rightRotate.click(function(){t.rotateImage('right')})}},beforeRender:function(e){this.getLoaderEl().show()},afterRender:function(e){var t=e.data;t.getLoaderEl().hide();t.alignCenter();t.imgEl.fadeIn(t.fadeSpeed);t.step=0;t.iW=t.imgEl.width();t.iH=t.imgEl.height();if(t.suitableHeigth){t.containerHeight=t.imgEl.height()}t.target.css({height:t.containerHeight});if(t.containerWidth<t.iW||t.containerHeight<t.iH)t.suitableImage(t.iW,t.iH);if(t.onAfterRender)t.onAfterRender(t)},afterLoad:function(e){var t=e.data;t.getLoaderEl().hide();t.onLoadError(t,t.getIndexValue(t.data,t.index),t.index)},onNext:function(e){var t=this;if(e&&e.data)t=e.data;t.onChangeImage(t,t.getIndexValue(t.data,t.index+1),t.index)},onPre:function(e){var t=this;if(e&&e.data)t=e.data;t.onChangeImage(t,t.getIndexValue(t.data,t.index-1),t.index)},goTo:function(index){var t=this;t.onChangeImage(t,t.getIndexValue(t.data,index),t.index)},hasNext:function(){var t=this;if(t.index>=t.data.length-1){return false}return true},hasPre:function(){var t=this;if(t.index<=0){return false}return true},renderImage:function(src){var t=this;if($.browser.msie){t.imgEl[0].style.filter='progid:DXImageTransform.Microsoft.BasicImage(rotation=0)';if(t.containerWidth<t.iW||t.containerHeight<t.iH){t.suitableImage(t.iW,t.iH)}}if(t.canvasEl){t.canvasEl.fadeOut(t.fadeSpeed,function(){t.fadeOutCallBack(src)})}else{t.imgEl.fadeOut(t.fadeSpeed,function(){t.fadeOutCallBack(src)})}if(t.overflowCursor=='revert'){if(t.index<=0){t.getPreEl().width('0%');t.getNextEl().width('100%')}else if(t.index>=t.data.length-1){t.getPreEl().width('100%');t.getNextEl().width('0%')}else{t.getPreEl().width('50%');t.getNextEl().width('50%')}}else if(t.overflowCursor=='gray'){if(t.index<=0){t.getPreEl().addClass('previewer-pre-dis')}else{t.getPreEl().attr('className','previewer-pre')}if(t.index>=t.data.length-1){t.getNextEl().addClass('previewer-next-dis')}else{t.getNextEl().attr('className','previewer-next')}}},fadeOutCallBack:function(src){var t=this;t.beforeRender();t.imgEl.width('');t.imgEl.height('');t.imgEl.attr('src',src)},rotateImage:function(direction){var t=this;var img=t.imgEl;var step=t.step;if(direction=='right'){(step==3)?step=0:step++}else if(direction=='left'){(step==0)?step=3:step--}t.step=step;t.imgEl.width('');t.imgEl.height('');if($.browser.msie){img[0].style.filter='progid:DXImageTransform.Microsoft.BasicImage(rotation='+step+')';var w,h,flag;w=t.imgEl.width();h=t.imgEl.height();if(step==0||step==2){flag=false}else if(step==1||step==3){flag=true}if(t.containerWidth<w||t.containerHeight<h)t.suitableImage(w,h,flag);t.alignCenter()}else{img.hide();if(!t.canvasEl){t.getBoxEl().append('<canvas></canvas>')}var c=t.getCanvasEl();c.show();var ctx=c[0].getContext('2d');var w,h;if(step==0||step==2){w=t.imgEl.width();h=t.imgEl.height()}else if(step==1||step==3){w=t.imgEl.height();h=t.imgEl.width()}var flag;if(t.containerWidth<w||t.containerHeight<h){t.suitableImage(w,h);flag=true}w=t.imgEl.width();h=t.imgEl.height();c.attr('width',w);c.attr('height',h);if(step==1||step==3){if(flag){var temp=w;w=h;h=temp}else{c.attr('width',h);c.attr('height',w)}}var radian=Math.PI/180;switch(step){default:case 0:ctx.rotate(0*radian);ctx.drawImage(img[0],0,0,w,h);break;case 1:ctx.rotate(90*radian);ctx.drawImage(img[0],0,-h,w,h);break;case 2:ctx.rotate(180*radian);ctx.drawImage(img[0],-w,-h,w,h);break;case 3:ctx.rotate(270*radian);ctx.drawImage(img[0],-w,0,w,h);break}}},suitableImage:function(iW,iH,flag){var t=this;var cW=t.containerWidth;var cH=t.containerHeight;if(!iW)iW=t.imgEl.width();if(!iH)iH=t.imgEl.height();var w=iW/cW;var h=iH/cH;if(w>h){var zoom=cW/iW;if(flag){w=iH*zoom;h=cW}else{w=cW;h=iH*zoom}t.imgEl.css({width:w,height:h})}else{var zoom=cH/iH;if(flag){w=cH;h=iW*zoom}else{w=iW*zoom;h=cH}t.imgEl.css({width:w,height:h})}t.alignCenter()},remove:function(index){var t=this;t.data.splice(index,1);if(index<t.data.length){t.goTo(index)}else{t.goTo(t.data.length-1)}},alignCenter:function(){var t=this;t.getBoxEl().css({top:((t.containerHeight-t.imgEl.height())/2),left:((t.containerWidth-t.imgEl.width())/2)})},getIndexValue:function(obj,index){if(index<0||index>=obj.length){if(this.interval){clearInterval(this.interval)}if(index<0)return'first';if(index>=obj.length)return'end'}this.index=index;return obj[index]},preloadImage:function(src){var t=this;t.getImgPreloadEl().attr('src',src)},getLoaderEl:function(){return this.loaderEl||(this.loaderEl=this.target.find('.previewer-loader'))},getImgEl:function(){return this.imgEl||(this.imgEl=this.target.find('.previewer-image'))},getNextEl:function(){return this.nextEl||(this.nextEl=this.target.find('.previewer-next'))},getPreEl:function(){return this.preEl||(this.preEl=this.target.find('.previewer-pre'))},getBoxEl:function(){return this.boxEl||(this.boxEl=this.target.find('.previewer-box'))},getCanvasEl:function(){return this.canvasEl||(this.canvasEl=this.target.find('canvas'))},getImgPreloadEl:function(){return this.imgPreloadEl||(this.imgPreloadEl=this.target.find('.previewer-image-preload'))}};$.fn.previewer=function(cfg){return new $.uiwidget.Previewer(this,cfg)}})(jQuery);