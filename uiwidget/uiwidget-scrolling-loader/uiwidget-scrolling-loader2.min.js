/**
 * 
 * 滚动条滚动到底部时，动态加载数据
 * 
 *  @author Vincent(zhongyongsheng@chinaduo.com)
 * 	@date 2011-11-11
 * 	@version 1.0.0
 */
;(function($){
	$.uiwidget = $.uiwidget || {};
	$.uiwidget.ScrollingLoader = function(target, cfg){
		cfg = $.extend({}, $.uiwidget.ScrollingLoader.defaults, cfg);
		$.extend(this, cfg);
		this.el = $(target);
		this.init();
	};
	
	$.uiwidget.ScrollingLoader.prototype = {
		fired : false
		,counter : 1
		,init : function(){
			me = this;
			el = me.el;
			el.parents(".song_room_wrap").bind('scroll', function(e){
				var t = Math.abs(parseFloat(el.css('top'))),
					height = me.getHeight(el),
					pHeight = el.parent().height();
//				console.log('height = ' + height + ',pHeight=' + pHeight + ',t=' + t + ',clientHeight= ' + el[0].clientHeight + ',offsetHeight=' + el[0].offsetHeight + ', el.css(top) = ' + el.css('top'));
				if( t >= (height - pHeight - me.bottomSpace) && me.fired == false){
					me.counter ++;
					me.callback({counter : me.counter});
					me.fired = true;
					if(me.delay != 0){
						me.defer(function(){
							me.fired = false;
						}, me.delay, me);
					}
				}
			});
		}
	
		,getHeight : function(el){
			return Math.max(el[0].offsetHeight, el[0].offsetHeight);
		}
		
		,createDelegate : function(method, obj, args, appendArgs){
	        return function() {
	            var callArgs = args || arguments;
	            if(appendArgs === true){
	                callArgs = Array.prototype.slice.call(arguments, 0);
	                callArgs = callArgs.concat(args);
	            }else if(typeof appendArgs == "number"){
	                callArgs = Array.prototype.slice.call(arguments, 0); 
	                var applyArgs = [appendArgs, 0].concat(args); 
	                Array.prototype.splice.apply(callArgs, applyArgs); 
	            }
	            return method.apply(obj || window, callArgs);
	        };
	    }
		
		,defer : function(method, millis, obj, args, appendArgs){
	        var fn = this.createDelegate(method, obj, args, appendArgs);
	        if(millis){
	            return setTimeout(fn, millis);
	        }
	        fn();
	        return 0;
	    }
	};
	
	$.uiwidget.ScrollingLoader.defaults = {
		delay : 2000
		,bottomSpace : 50
	};
	
	$.fn.scrollingLoader = function(cfg){
		return new $.uiwidget.ScrollingLoader(this, cfg);
	};
})(jQuery);	